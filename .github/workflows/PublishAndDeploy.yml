name: Publish_and_Deploy
on:
  push:
    branches:
    - master

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
    - uses: azure/docker-login@v1
      with:
        login-server: mtscontainers.azurecr.io
        username: ${{ secrets.DTS_AZURE_USERNAME }}
        password: ${{ secrets.DTS_AZURE_PASSWORD }}
    - uses: actions/checkout@v1
    - name: docker build and push
      run: |
        docker build -t mtscontainers.azurecr.io/dts-scheduler:latest .
        docker tag mtscontainers.azurecr.io/dts-scheduler:latest mtscontainers.azurecr.io/dts-scheduler:BUILD_ID
        docker push mtscontainers.azurecr.io/dts-scheduler:latest
        docker push mtscontainers.azurecr.io/dts-scheduler:BUILD_ID

  Deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
    - name: trigger single Job
      uses: appleboy/jenkins-action@master
      with:
        url: "https://jenkins.esdc.online/job/dts-scheduler/buildWithParameters?token=${{ secrets.DTS_JENKINS_TOKEN}}&docker_tag=latest"
        user: "jenkinsbot"
        token: ${{ secrets.DTS_JENKINS_TOKEN}}
        job: "dts-scheduler"


